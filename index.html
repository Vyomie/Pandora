<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pandora Document Viewer</title>
<style>
  html, body {
    background: #f0f0f3;
    margin: 0;
    padding: 0;
    font-family: "Times New Roman", serif;
    color: #222;
  }

  #toolbar {
    position: fixed;
    top: 10px;
    right: 10px;
    background: rgba(255,255,255,0.95);
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 0.4rem 0.8rem;
    font-family: sans-serif;
    z-index: 10;
  }
  #toolbar input[type="file"] { display: none; }
  #toolbar label { cursor: pointer; color: #007acc; text-decoration: underline; }

  .page {
    width: 210mm;
    min-height: 297mm;
    margin: 2rem auto;
    background: #fff;
    box-shadow: 0 0 15px rgba(0,0,0,0.15);
    padding: 25mm;
    box-sizing: border-box;
  }

  .columns {
    column-count: 2;
    column-gap: 20mm;
  }

  .block {
    break-inside: avoid;
    margin-bottom: 1.2rem;
  }

  video, img {
    display: block;
    margin: 1em auto;
    border: none;
    box-shadow: none;
    max-width: 100%;
  }

  svg {
    display: block;
    max-width: 100%;
    margin: 0 auto;
  }

  pre {
    background: none;
    border: none;
    padding: 0;
    margin: 0.5rem 0;
    font-family: "Courier New", monospace;
    font-size: 1em;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .error {
    color: #a33;
    font-family: monospace;
    font-size: 0.9em;
    background: #fff3f3;
    border: 1px solid #ffcccc;
    padding: 0.3rem;
    border-radius: 4px;
  }

  #loader {
    text-align: center;
    color: #777;
    margin-top: 4rem;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>

<div id="toolbar">
  <label for="fileInput">Open .pandora</label>
  <input type="file" id="fileInput" accept=".pandora">
</div>

<div id="document"></div>

<script>
(async function(){
  const docContainer = document.getElementById('document');
  const input = document.getElementById('fileInput');

  input.addEventListener('change', e=>{
    if(e.target.files.length) loadPandora(e.target.files[0]);
  });

  document.body.addEventListener('dragover', e=>e.preventDefault());
  document.body.addEventListener('drop', e=>{
    e.preventDefault();
    const f = e.dataTransfer.files[0];
    if(f && f.name.endsWith('.pandora')) loadPandora(f);
  });

  async function loadPandora(file){
    docContainer.innerHTML = '<div id="loader">Loading...</div>';

    const buf = await file.arrayBuffer();
    const zip = await JSZip.loadAsync(buf);
    const metaFile = zip.file('meta.json');
    if(!metaFile){
      docContainer.innerHTML = '<div class="error">meta.json not found</div>';
      return;
    }

    const meta = JSON.parse(await metaFile.async('string'));
    const seq = meta.sequence || [];

    // preload all blobs like before
    const entries = {};
    await Promise.all(Object.keys(zip.files).map(async k=>{
      if(k === 'meta.json') return;
      const f = zip.files[k];
      if(f.dir) return;
      const blob = await f.async('blob');
      entries[k] = URL.createObjectURL(blob);
    }));

    docContainer.innerHTML = '';
    let page = createPage(meta.layout);
    docContainer.appendChild(page);

    for(const item of seq){
      // Check for explicit or inline pagebreak
      if(item.pagebreak || (item.text && /\\(newpage|pagebreak)/.test(item.text))){
        page = createPage(meta.layout);
        docContainer.appendChild(page);
        continue;
      }

      const block = document.createElement('div');
      block.className = 'block';

      try {
        if(item.type === 'latex'){
          if(item.rendered && entries[item.rendered]){
            const img = document.createElement('img');
            img.src = entries[item.rendered];
            block.appendChild(img);
          } else {
            const pre = document.createElement('pre');
            let latexSource = item.file && zip.file(item.file)
              ? await zip.file(item.file).async('string')
              : item.text || '(empty LaTeX block)';
            pre.textContent = latexSource;
            block.appendChild(pre);
            await MathJax.typesetPromise([pre]);
          }
        } else if(item.type === 'video'){
          const vid = document.createElement('video');
          if(entries[item.file]) vid.src = entries[item.file];
          vid.loop = true;
          vid.autoplay = true;
          vid.muted = true;
          vid.playsInline = true;
          vid.controls = false;

          // custom sizing
          if(item.width) vid.style.width = item.width;
          if(item.height) vid.style.height = item.height;
          if(item.scale) vid.style.width = (parseFloat(item.scale)*100)+'%';

          block.appendChild(vid);
        } else if(item.type === 'image'){
          const img = document.createElement('img');
          if(entries[item.file]) img.src = entries[item.file];
          if(item.width) img.style.width = item.width;
          if(item.height) img.style.height = item.height;
          if(item.scale) img.style.width = (parseFloat(item.scale)*100)+'%';
          block.appendChild(img);
        }
      } catch (err){
        const ebox = document.createElement('div');
        ebox.className='error';
        ebox.textContent = '[Error rendering block: ' + err.message + ']';
        block.appendChild(ebox);
      }

      page.querySelector('.page-body').appendChild(block);
    }
  }

  function createPage(layout){
    const page = document.createElement('div');
    page.className = 'page';
    const body = document.createElement('div');
    body.className = 'page-body';
    if(layout === 'two-column' || /two.?column/i.test(layout)) body.classList.add('columns');
    page.appendChild(body);
    return page;
  }
})();
</script>
</body>
</html>
